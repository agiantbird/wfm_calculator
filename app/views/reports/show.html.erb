<div class="container">
<% if @report.report_type == "fte" %>
  <h1>FTE Report Results</h1>
  <p>User: <%= @report.user.name %></p>

  <div class="info-box">
    <h3>How FTE is Calculated:</h3>
    <p>
      <strong>FTE Needed = (Incoming Requests per Hour × Average Resolution Time) ÷ Requests Completed per Employee per Hour</strong>
    </p>
    <p>
      This formula calculates the number of full-time employees needed to handle your support workload based on request volume, resolution time, and employee productivity.
    </p>
  </div>

  <div class="results-section">
    <h2>Parameters:</h2>
    <ul>
      <li>Incoming requests per hour: <%= @report.parameters["incoming_requests_per_hour"] %></li>
      <li>Average resolution time per support request: <%= @report.parameters["average_resolution_time"] %> hours</li>
      <li>Requests completed per employee per hour: <%= @report.parameters["requests_per_employee_per_hour"] %></li>
    </ul>

    <h2>Result:</h2>
    <p><strong>You will need <%= @report.results["fte_needed"].round(2) %> Full-Time Employees</strong></p>
  </div>

  <h2>Scenario Analysis:</h2>
  <p>This table shows how many agents would be needed if your parameters change. Each column shows the impact of changing one parameter in isolation, plus a combined scenario where all parameters scale together.</p>

  <%
    # Extract baseline parameters
    incoming_requests = @report.parameters["incoming_requests_per_hour"].to_f
    resolution_time = @report.parameters["average_resolution_time"].to_f
    requests_per_employee = @report.parameters["requests_per_employee_per_hour"].to_f

    # Define multipliers
    multipliers = [0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5]
  %>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Multiplier</th>
          <th>Incoming Requests Only<br><span>(others constant)</span></th>
          <th>Resolution Time Only<br><span>(others constant)</span></th>
          <th>Productivity Only<br><span>(others constant)</span></th>
          <th>Request & Resolution<br><span>(productivity constant)</span></th>
          <th>Request, Resolution, & Productivity</th>
        </tr>
      </thead>
      <tbody>
        <% multipliers.each do |mult| %>
          <%
            # Calculate FTE for each scenario
            fte_requests = (incoming_requests * mult * resolution_time) / requests_per_employee
            fte_resolution = (incoming_requests * resolution_time * mult) / requests_per_employee
            fte_productivity = (incoming_requests * resolution_time) / (requests_per_employee * mult)
            fte_request_resolution = (incoming_requests * mult * resolution_time * mult) / requests_per_employee
            fte_all_combined = (incoming_requests * mult * resolution_time * mult) / (requests_per_employee * mult)

            # Highlight baseline row
            row_class = mult == 1 ? "baseline-row" : ""
          %>
          <tr class="<%= row_class %>">
            <td><%= mult %>x</td>
            <td><%= fte_requests.round(2) %></td>
            <td><%= fte_resolution.round(2) %></td>
            <td><%= fte_productivity.round(2) %></td>
            <td><%= fte_request_resolution.round(2) %></td>
            <td><%= fte_all_combined.round(2) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="info-box-blue">
    <h4>Understanding the Table:</h4>
    <ul>
      <li><strong>Incoming Requests Only:</strong> Shows FTE needed if request volume changes (e.g., 2x = double the requests)</li>
      <li><strong>Resolution Time Only:</strong> Shows FTE needed if handling time changes (e.g., 2x = requests take twice as long)</li>
      <li><strong>Productivity Only:</strong> Shows FTE needed if employee efficiency changes (e.g., 2x = employees complete twice as many requests/hour)</li>
      <li><strong>Request & Resolution:</strong> Shows FTE needed if both requests and resolution time scale together (productivity stays constant)</li>
      <li><strong>Request, Resolution, & Productivity:</strong> Shows FTE needed if all three factors scale together by the same amount</li>
      <li><strong>Yellow row (1x):</strong> Your baseline scenario with current parameters</li>
    </ul>
  </div>

<% elsif @report.report_type == "erlang" %>
  <h1>Erlang C Staffing Model Results</h1>
  <p>User: <%= @report.user.name %></p>

  <div class="info-box">
    <h3>How Erlang C is Calculated:</h3>
    <p>
      <strong>The Erlang C model calculates the minimum number of agents needed to meet your service level target.</strong>
    </p>
    <p>
      The formula considers call volume, average handling time, and finds the smallest number of agents where:<br>
      <em>(1 − Probability of Delay × e^(−(Agent Surplus × Target Time ÷ AHT))) ≥ Service Level Target</em>
    </p>
    <p>
      This ensures that the specified percentage of calls are answered within your target time.
    </p>
  </div>

  <div class="results-section">
    <h2>Parameters:</h2>
    <ul>
      <li>Call volume: <%= @report.parameters["call_volume"] %> calls per hour</li>
      <li>Average Handling Time (AHT): <%= @report.parameters["average_handling_time"] %> seconds</li>
      <li>Service Level Target: <%= @report.parameters["service_level_target"] %>%</li>
      <li>Target Time: <%= @report.parameters["target_time"] %> seconds</li>
    </ul>

    <h2>Results:</h2>
    <p><strong>You will need <%= @report.results["agents_needed"] %> Agents</strong></p>
    <p>Traffic Intensity: <%= @report.results["traffic_intensity"].round(2) %> Erlangs</p>
  </div>

  <h2>Scenario Analysis:</h2>
  <p>This table shows how many agents would be needed if your parameters change. Each column shows the impact of changing one parameter in isolation, plus a combined scenario where all parameters scale together.</p>

  <%
    # Extract baseline parameters
    call_volume = @report.parameters["call_volume"].to_f
    aht = @report.parameters["average_handling_time"].to_f
    service_level_target = @report.parameters["service_level_target"].to_f
    target_time = @report.parameters["target_time"].to_f

    # Define multipliers
    multipliers = [0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5]

    # Calculate service level target increments
    # For 0.5x: baseline - 5
    # For 1x: baseline
    # For remaining rows (1.5x to 5x): incremental steps from baseline to 100
    step_size = (100.0 - service_level_target) / 8.0
  %>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Multiplier</th>
          <th>Call Volume Only<br><span>(others constant)</span></th>
          <th>Avg Handling Time Only<br><span>(others constant)</span></th>
          <th>Service Level Target Only<br><span>(others constant)</span></th>
          <th>Target Time Only<br><span>(others constant)</span></th>
          <th>All Combined</th>
        </tr>
      </thead>
      <tbody>
        <% multipliers.each_with_index do |mult, index| %>
          <%
            # Calculate service level target for this row
            if mult == 0.5
              sl_target_for_row = [service_level_target - 5, 0].max  # Reduced by 5, minimum 0
            elsif mult == 1
              sl_target_for_row = service_level_target  # Baseline
            else
              # Incremental steps from baseline to 100
              step_number = index - 1  # Steps start from 1.5x (index 2), so step 1
              sl_target_for_row = [service_level_target + (step_size * step_number), 100].min  # Maximum 100
            end

            # Calculate traffic intensity for each scenario
            traffic_call_volume = (call_volume * mult * aht) / 3600.0
            traffic_aht = (call_volume * aht * mult) / 3600.0
            traffic_baseline = (call_volume * aht) / 3600.0
            traffic_combined = (call_volume * mult * aht * mult) / 3600.0

            # Calculate agents for each scenario using helper methods
            agents_call_volume = calculate_erlang_agents(traffic_call_volume, service_level_target / 100.0, target_time, aht)
            agents_aht = calculate_erlang_agents(traffic_aht, service_level_target / 100.0, target_time, aht * mult)
            agents_sl_target = calculate_erlang_agents(traffic_baseline, sl_target_for_row / 100.0, target_time, aht)
            agents_target_time = calculate_erlang_agents(traffic_baseline, service_level_target / 100.0, target_time * mult, aht)
            agents_combined = calculate_erlang_agents(traffic_combined, sl_target_for_row / 100.0, target_time * mult, aht * mult)

            # Highlight baseline row
            row_class = mult == 1 ? "baseline-row" : ""
          %>
          <tr class="<%= row_class %>">
            <td><%= mult %>x</td>
            <td><%= agents_call_volume %></td>
            <td><%= agents_aht %></td>
            <td><%= agents_sl_target %> <span class="text-muted">(SL: <%= sl_target_for_row.round(1) %>%)</span></td>
            <td><%= agents_target_time %></td>
            <td><%= agents_combined %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="info-box-blue">
    <h4>Understanding the Table:</h4>
    <ul>
      <li><strong>Call Volume Only:</strong> Shows agents needed if call volume changes (e.g., 2x = double the calls)</li>
      <li><strong>Avg Handling Time Only:</strong> Shows agents needed if handling time changes (e.g., 2x = calls take twice as long)</li>
      <li><strong>Service Level Target Only:</strong> Shows agents needed if service level target changes (0.5x = baseline - 5%, 1x = baseline, 1.5x+ = incremental steps to 100%)</li>
      <li><strong>Target Time Only:</strong> Shows agents needed if target answer time changes (e.g., 2x = twice as much time to answer)</li>
      <li><strong>All Combined:</strong> Shows agents needed if call volume, AHT, service level target, and target time all scale together</li>
      <li><strong>Yellow row (1x):</strong> Your baseline scenario with current parameters</li>
    </ul>
  </div>

<% end %>

  <div class="action-links">
    <%= link_to "Export as CSV", export_csv_report_path(@report), class: "btn-link" %>
    <%= link_to "Back to Home", root_path %>
  </div>
</div>
